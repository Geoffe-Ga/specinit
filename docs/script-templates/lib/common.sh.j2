#!/bin/bash
# =============================================================================
# common.sh - Shared utility functions for {{ project_name }} scripts
# =============================================================================
# Generated by SpecInit - https://github.com/specinit/specinit
# =============================================================================

# Prevent double-sourcing
[[ -n "${_COMMON_LOADED:-}" ]] && return
_COMMON_LOADED=1

# =============================================================================
# Exit Codes (standardized across all scripts)
# =============================================================================

readonly EXIT_SUCCESS=0
readonly EXIT_LINT_FAIL=1
readonly EXIT_TEST_FAIL=2
readonly EXIT_SETUP_FAIL=3
readonly EXIT_MISSING_DEPS=4
readonly EXIT_INVALID_ARGS=5

# =============================================================================
# Configuration
# =============================================================================

VERBOSE="${VERBOSE:-false}"
QUIET="${QUIET:-false}"
LOG_DIR="${LOG_DIR:-.logs}"

# =============================================================================
# Colors
# =============================================================================

setup_colors() {
    if [[ -t 1 ]] && [[ -z "${NO_COLOR:-}" ]]; then
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[0;33m'
        BLUE='\033[0;34m'
        MAGENTA='\033[0;35m'
        CYAN='\033[0;36m'
        BOLD='\033[1m'
        DIM='\033[2m'
        RESET='\033[0m'
    else
        RED=''
        GREEN=''
        YELLOW=''
        BLUE=''
        MAGENTA=''
        CYAN=''
        BOLD=''
        DIM=''
        RESET=''
    fi
}

# =============================================================================
# Logging Functions
# =============================================================================

_log() {
    local level="$1"
    local color="$2"
    shift 2
    local timestamp
    timestamp=$(date '+%H:%M:%S')
    echo -e "${DIM}[${timestamp}]${RESET} ${color}${level}${RESET} $*"
}

log_info() {
    [[ "$QUIET" == "true" ]] && return
    _log "INFO" "$BLUE" "$@"
}

log_success() {
    _log "PASS" "$GREEN" "$@"
}

log_warn() {
    _log "WARN" "$YELLOW" "$@"
}

log_error() {
    _log "FAIL" "$RED" "$@" >&2
}

log_debug() {
    [[ "$VERBOSE" != "true" ]] && return
    _log "DEBUG" "$DIM" "$@"
}

log_step() {
    echo ""
    echo -e "${BOLD}${CYAN}=== $* ===${RESET}"
}

log_summary() {
    echo ""
    echo -e "${BOLD}${MAGENTA}━━━ $* ━━━${RESET}"
}

# =============================================================================
# Log File Management
# =============================================================================

setup_log_file() {
    local log_type="$1"
    local log_subdir="${LOG_DIR}/${log_type}"
    local timestamp
    timestamp=$(date '+%Y-%m-%d_%H%M%S')
    local log_file="${log_subdir}/${timestamp}_${log_type}.log"

    mkdir -p "$log_subdir"
    touch "$log_file"

    # Create/update symlink to latest
    local latest_link="${log_subdir}/latest.log"
    ln -sf "$(basename "$log_file")" "$latest_link"

    echo "$log_file"
}

# =============================================================================
# Utility Functions
# =============================================================================

command_exists() {
    command -v "$1" &>/dev/null
}

require_command() {
    local cmd="$1"
    local install_hint="${2:-}"

    if ! command_exists "$cmd"; then
        log_error "Required command not found: $cmd"
        [[ -n "$install_hint" ]] && log_info "Install with: $install_hint"
        exit $EXIT_MISSING_DEPS
    fi
}

format_duration() {
    local seconds="$1"
    if (( seconds < 60 )); then
        echo "${seconds}s"
    elif (( seconds < 3600 )); then
        echo "$((seconds / 60))m $((seconds % 60))s"
    else
        echo "$((seconds / 3600))h $((seconds % 3600 / 60))m"
    fi
}

# Initialize colors by default
setup_colors
