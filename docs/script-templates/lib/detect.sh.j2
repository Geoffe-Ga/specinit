#!/bin/bash
# =============================================================================
# detect.sh - Language and framework detection for {{ project_name }}
# =============================================================================
# Generated by SpecInit - https://github.com/specinit/specinit
# =============================================================================

# Prevent double-sourcing
[[ -n "${_DETECT_LOADED:-}" ]] && return
_DETECT_LOADED=1

# =============================================================================
# Language Detection
# =============================================================================
{% if has_python %}

detect_python() {
    [[ -f "pyproject.toml" ]] || [[ -f "setup.py" ]] || [[ -f "requirements.txt" ]]
}
{% endif %}
{% if has_frontend %}

detect_frontend() {
    [[ -f "package.json" ]] || [[ -f "{{ frontend_dir }}/package.json" ]]
}
{% endif %}

# =============================================================================
# Tool Detection
# =============================================================================
{% if has_python %}

detect_pytest() {
    if [[ -f "pyproject.toml" ]]; then
        grep -q '\[tool\.pytest' pyproject.toml 2>/dev/null && return 0
        grep -q 'pytest' pyproject.toml 2>/dev/null && return 0
    fi
    [[ -f "pytest.ini" ]] || [[ -f "setup.cfg" ]] && grep -q 'pytest' setup.cfg 2>/dev/null
}

detect_ruff() {
    [[ -f "pyproject.toml" ]] && grep -q '\[tool\.ruff\]' pyproject.toml 2>/dev/null
}

detect_mypy() {
    [[ -f "pyproject.toml" ]] && grep -q '\[tool\.mypy\]' pyproject.toml 2>/dev/null
}
{% endif %}
{% if has_frontend %}

detect_eslint() {
    local frontend_dir="{{ frontend_dir }}"
    [[ -f "${frontend_dir}/.eslintrc.js" ]] || \
    [[ -f "${frontend_dir}/.eslintrc.json" ]] || \
    [[ -f "${frontend_dir}/.eslintrc.cjs" ]] || \
    [[ -f "${frontend_dir}/eslint.config.js" ]] || \
    [[ -f "${frontend_dir}/eslint.config.mjs" ]] || \
    grep -q '"eslint"' "${frontend_dir}/package.json" 2>/dev/null
}

detect_prettier() {
    local frontend_dir="{{ frontend_dir }}"
    [[ -f "${frontend_dir}/.prettierrc" ]] || \
    [[ -f "${frontend_dir}/.prettierrc.json" ]] || \
    [[ -f "${frontend_dir}/.prettierrc.js" ]] || \
    [[ -f "${frontend_dir}/prettier.config.js" ]] || \
    grep -q '"prettier"' "${frontend_dir}/package.json" 2>/dev/null
}

detect_typescript() {
    local frontend_dir="{{ frontend_dir }}"
    [[ -f "${frontend_dir}/tsconfig.json" ]]
}

detect_package_manager() {
    local frontend_dir="{{ frontend_dir }}"
    if [[ -f "${frontend_dir}/pnpm-lock.yaml" ]]; then
        echo "pnpm"
    elif [[ -f "${frontend_dir}/yarn.lock" ]]; then
        echo "yarn"
    else
        echo "npm"
    fi
}
{% endif %}

# =============================================================================
# Directory Detection
# =============================================================================
{% if has_python %}

get_python_src_dirs() {
    local dirs=""
    [[ -d "src" ]] && dirs="src"
    [[ -d "{{ python_src_dir }}" ]] && dirs="${dirs:+$dirs }{{ python_src_dir }}"
    echo "$dirs" | xargs
}

get_python_test_dirs() {
    local dirs=""
    [[ -d "tests" ]] && dirs="tests"
    [[ -d "test" ]] && dirs="${dirs:+$dirs }test"
    echo "$dirs" | xargs
}

get_python_dirs() {
    local src_dirs
    local test_dirs
    src_dirs=$(get_python_src_dirs)
    test_dirs=$(get_python_test_dirs)
    echo "$src_dirs $test_dirs" | xargs
}
{% endif %}
{% if has_frontend %}

get_frontend_dir() {
    if [[ -f "{{ frontend_dir }}/package.json" ]]; then
        echo "{{ frontend_dir }}"
    elif [[ -f "package.json" ]]; then
        echo "."
    fi
}
{% endif %}
