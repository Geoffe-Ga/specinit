#!/bin/bash
# =============================================================================
# check.sh - Run all checks (lint + test) for {{ project_name }}
# =============================================================================
# Generated by SpecInit - https://github.com/specinit/specinit
#
# This script runs both linting and testing in sequence.
# Useful for pre-commit validation or CI.
#
# Usage:
#   ./scripts/check.sh [options]
#
# Options:
#   --verbose, -v   Show detailed output
#   --quiet, -q     Minimal output
#   --fix           Auto-fix lint issues before testing
#   --lint-only     Run only linting
#   --test-only     Run only tests
#   --help, -h      Show this help message
#
# =============================================================================

set -eo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/lib/common.sh"

# =============================================================================
# Configuration
# =============================================================================

FIX_MODE=false
LINT_ONLY=false
TEST_ONLY=false
PASSTHROUGH_ARGS=()
START_TIME=$(date +%s)

# =============================================================================
# Help
# =============================================================================

show_help() {
    cat << 'EOF'
check.sh - Run all checks (lint + test) for {{ project_name }}

USAGE:
    ./scripts/check.sh [OPTIONS]

OPTIONS:
    --verbose, -v   Show detailed output
    --quiet, -q     Minimal output
    --fix           Auto-fix lint issues before testing
    --lint-only     Run only linting
    --test-only     Run only tests
    --help, -h      Show this help message

EXAMPLES:
    ./scripts/check.sh              # Run all checks
    ./scripts/check.sh --fix        # Fix lint issues, then test
    ./scripts/check.sh --lint-only  # Only run linting
EOF
}

# =============================================================================
# Argument Parsing
# =============================================================================

parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            --verbose|-v)
                VERBOSE=true
                PASSTHROUGH_ARGS+=("--verbose")
                shift
                ;;
            --quiet|-q)
                QUIET=true
                PASSTHROUGH_ARGS+=("--quiet")
                shift
                ;;
            --fix)
                FIX_MODE=true
                shift
                ;;
            --lint-only)
                LINT_ONLY=true
                shift
                ;;
            --test-only)
                TEST_ONLY=true
                shift
                ;;
            --help|-h)
                show_help
                exit 0
                ;;
            *)
                log_error "Unknown option: $1"
                exit $EXIT_INVALID_ARGS
                ;;
        esac
    done
}

# =============================================================================
# Main
# =============================================================================

main() {
    setup_colors
    parse_args "$@"

    log_info "Starting full check suite..."

    local lint_exit=0
    local test_exit=0

    # Run linting
    if [[ "$TEST_ONLY" != true ]]; then
        log_step "Running Linting"

        local lint_args=("${PASSTHROUGH_ARGS[@]}")
        [[ "$FIX_MODE" == true ]] && lint_args+=("--fix")

        if "${SCRIPT_DIR}/lint.sh" "${lint_args[@]}"; then
            log_success "Linting passed"
        else
            lint_exit=$?
            log_error "Linting failed"
        fi
    fi

    # Run tests (only if lint passed or we're in fix mode)
    if [[ "$LINT_ONLY" != true ]]; then
        if [[ $lint_exit -eq 0 ]] || [[ "$FIX_MODE" == true ]]; then
            log_step "Running Tests"

            if "${SCRIPT_DIR}/test.sh" "${PASSTHROUGH_ARGS[@]}"; then
                log_success "Tests passed"
            else
                test_exit=$?
                log_error "Tests failed"
            fi
        else
            log_warn "Skipping tests due to lint failures"
            test_exit=1
        fi
    fi

    # Calculate duration
    local end_time duration
    end_time=$(date +%s)
    duration=$((end_time - START_TIME))

    # Summary
    log_summary "Check Summary"

    if [[ $lint_exit -eq 0 ]] && [[ $test_exit -eq 0 ]]; then
        log_success "All checks passed! ($(format_duration $duration))"
        exit $EXIT_SUCCESS
    else
        [[ $lint_exit -ne 0 ]] && log_error "Linting failed"
        [[ $test_exit -ne 0 ]] && log_error "Tests failed"
        log_info "Total time: $(format_duration $duration)"
        [[ $lint_exit -ne 0 ]] && exit $EXIT_LINT_FAIL
        exit $EXIT_TEST_FAIL
    fi
}

main "$@"
