#!/bin/bash
# =============================================================================
# setup.sh - Project setup for {{ project_name }}
# =============================================================================
# Generated by SpecInit - https://github.com/Geoffe-Ga/specinit
#
# Sets up the development environment:
{% if has_python %}#   - Creates Python virtual environment (if needed)
#   - Installs Python dependencies
{% endif %}{% if has_frontend %}#   - Installs frontend dependencies
{% endif %}#   - Installs pre-commit hooks
#
# Usage:
#   ./scripts/setup.sh [options]
#
# =============================================================================

set -eo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/lib/common.sh"
source "${SCRIPT_DIR}/lib/detect.sh"

# =============================================================================
# Configuration
# =============================================================================

{% if has_python %}SKIP_VENV=false
{% endif %}{% if has_frontend %}SKIP_FRONTEND=false
{% endif %}SKIP_PRECOMMIT=false
CI_MODE=false

# =============================================================================
# Help
# =============================================================================

show_help() {
    cat << 'EOF'
setup.sh - Project setup for {{ project_name }}

USAGE:
    ./scripts/setup.sh [OPTIONS]

OPTIONS:
    --verbose, -v      Show detailed output
    --quiet, -q        Minimal output
{% if has_python %}    --skip-venv        Skip virtual environment creation
{% endif %}{% if has_frontend %}    --skip-frontend    Skip frontend setup
{% endif %}    --skip-precommit   Skip pre-commit hook installation
    --ci               CI mode (skip interactive prompts)
    --help, -h         Show this help message

EXAMPLES:
    ./scripts/setup.sh              # Full setup
    ./scripts/setup.sh --ci         # CI environment setup
EOF
}

# =============================================================================
# Argument Parsing
# =============================================================================

parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            --verbose|-v)
                VERBOSE=true
                shift
                ;;
            --quiet|-q)
                QUIET=true
                shift
                ;;
{% if has_python %}            --skip-venv)
                SKIP_VENV=true
                shift
                ;;
{% endif %}{% if has_frontend %}            --skip-frontend)
                SKIP_FRONTEND=true
                shift
                ;;
{% endif %}            --skip-precommit)
                SKIP_PRECOMMIT=true
                shift
                ;;
            --ci)
                CI_MODE=true
                shift
                ;;
            --help|-h)
                show_help
                exit 0
                ;;
            *)
                log_error "Unknown option: $1"
                exit $EXIT_INVALID_ARGS
                ;;
        esac
    done
}

# =============================================================================
# Setup Functions
# =============================================================================
{% if has_python %}

setup_python() {
    if ! detect_python; then
        log_debug "No Python project detected, skipping"
        return 0
    fi

    log_step "Python Setup"

    require_command python "brew install python OR apt install python3"

    # Virtual environment
    if [[ "$SKIP_VENV" != true ]]; then
        if [[ ! -d ".venv" ]]; then
            log_info "Creating virtual environment..."
            python -m venv .venv
            log_success "Virtual environment created at .venv"
        else
            log_debug "Virtual environment already exists"
        fi

        log_info "Activating virtual environment..."
        # shellcheck disable=SC1091
        source .venv/bin/activate
    fi

    # Install dependencies
    log_info "Installing Python dependencies..."
    pip install --upgrade pip

    if [[ -f "pyproject.toml" ]]; then
        pip install -e ".[dev]"
    elif [[ -f "requirements.txt" ]]; then
        pip install -r requirements.txt
        [[ -f "requirements-dev.txt" ]] && pip install -r requirements-dev.txt
    fi

    log_success "Python dependencies installed"
}
{% endif %}
{% if has_frontend %}

setup_frontend() {
    if [[ "$SKIP_FRONTEND" == true ]]; then
        return 0
    fi

    if ! detect_frontend; then
        log_debug "No frontend project detected, skipping"
        return 0
    fi

    log_step "Frontend Setup"

    local frontend_dir
    frontend_dir=$(get_frontend_dir)

    if [[ -z "$frontend_dir" ]] || [[ ! -d "$frontend_dir" ]]; then
        log_warn "Frontend directory not found"
        return 0
    fi

    pushd "$frontend_dir" > /dev/null

    require_command node "brew install node OR nvm install node"
    require_command npm "Comes with Node.js installation"

    log_info "Node.js version: $(node --version)"
    log_info "npm version: $(npm --version)"

    log_info "Installing frontend dependencies..."

    local pkg_manager
    pkg_manager=$(detect_package_manager)

    case "$pkg_manager" in
        pnpm)
            require_command pnpm "npm install -g pnpm"
            pnpm install
            ;;
        yarn)
            require_command yarn "npm install -g yarn"
            yarn install
            ;;
        *)
            if [[ -f "package-lock.json" ]]; then
                npm ci
            else
                npm install
            fi
            ;;
    esac

    log_success "Frontend dependencies installed"

    popd > /dev/null
}
{% endif %}

setup_precommit() {
    if [[ "$SKIP_PRECOMMIT" == true ]]; then
        return 0
    fi

    if [[ ! -f ".pre-commit-config.yaml" ]]; then
        log_debug "No pre-commit config found, skipping"
        return 0
    fi

    log_step "Pre-commit Setup"

    if ! command_exists pre-commit; then
        log_info "Installing pre-commit..."
        pip install pre-commit
    fi

    log_info "Installing pre-commit hooks..."
    pre-commit install

    log_success "Pre-commit hooks installed"
}

# =============================================================================
# Main
# =============================================================================

main() {
    setup_colors
    parse_args "$@"

    log_info "Setting up development environment..."
{% if has_python %}
    setup_python
{% endif %}{% if has_frontend %}
    setup_frontend
{% endif %}
    setup_precommit

    log_summary "Setup Complete"
    log_success "Development environment is ready!"

    echo ""
    log_info "Next steps:"
{% if has_python %}    echo "  source .venv/bin/activate  # Activate virtual environment"
{% endif %}    echo "  ./scripts/check.sh         # Run all checks"
    echo "  ./scripts/test.sh          # Run tests"
}

main "$@"
