#!/bin/bash
# =============================================================================
# lint.sh - Unified linting for {{ project_name }}
# =============================================================================
# Generated by SpecInit - https://github.com/Geoffe-Ga/specinit
#
# Runs configured linters:
{% if has_python %}#   - Python: ruff, mypy
{% endif %}{% if has_frontend %}#   - Frontend: ESLint, TypeScript
{% endif %}#
# Usage:
#   ./scripts/lint.sh [options] [paths...]
#
# Options:
#   --fix           Auto-fix issues where possible
#   --verbose, -v   Show detailed output
#   --quiet, -q     Minimal output
{% if has_python and has_frontend %}#   --python        Lint Python only
#   --frontend      Lint frontend only
{% endif %}#   --help, -h      Show this help message
#
# =============================================================================

set -eo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/lib/common.sh"
source "${SCRIPT_DIR}/lib/detect.sh"

# =============================================================================
# Configuration
# =============================================================================

FIX_MODE=false
{% if has_python and has_frontend %}PYTHON_ONLY=false
FRONTEND_ONLY=false
{% endif %}CUSTOM_PATHS=()
ERRORS=0
START_TIME=$(date +%s)

# =============================================================================
# Help
# =============================================================================

show_help() {
    cat << 'EOF'
lint.sh - Unified linting for {{ project_name }}

USAGE:
    ./scripts/lint.sh [OPTIONS] [PATHS...]

OPTIONS:
    --fix           Auto-fix issues where possible
    --verbose, -v   Show detailed output
    --quiet, -q     Minimal output
{% if has_python and has_frontend %}    --python        Lint Python only
    --frontend      Lint frontend only
{% endif %}    --help, -h      Show this help message

EXAMPLES:
    ./scripts/lint.sh              # Lint everything
    ./scripts/lint.sh --fix        # Auto-fix issues
{% if has_python %}    ./scripts/lint.sh src/          # Lint specific path
{% endif %}EOF
}

# =============================================================================
# Argument Parsing
# =============================================================================

parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            --fix)
                FIX_MODE=true
                shift
                ;;
            --verbose|-v)
                VERBOSE=true
                shift
                ;;
            --quiet|-q)
                QUIET=true
                shift
                ;;
{% if has_python and has_frontend %}            --python)
                PYTHON_ONLY=true
                shift
                ;;
            --frontend)
                FRONTEND_ONLY=true
                shift
                ;;
{% endif %}            --help|-h)
                show_help
                exit 0
                ;;
            -*)
                log_error "Unknown option: $1"
                exit $EXIT_INVALID_ARGS
                ;;
            *)
                CUSTOM_PATHS+=("$1")
                shift
                ;;
        esac
    done
}

# =============================================================================
# Linting Functions
# =============================================================================
{% if has_python %}

lint_python() {
    if ! detect_python; then
        log_debug "No Python project detected, skipping"
        return 0
    fi

    log_step "Python Linting"

    local python_dirs
    if [[ ${#CUSTOM_PATHS[@]} -gt 0 ]]; then
        python_dirs="${CUSTOM_PATHS[*]}"
    else
        python_dirs=$(get_python_dirs)
    fi

    if [[ -z "$python_dirs" ]]; then
        log_warn "No Python directories found"
        return 0
    fi

    local has_errors=false

    # Ruff check
    if python -m ruff --version &>/dev/null; then
        local ruff_args="check"
        [[ "$FIX_MODE" == true ]] && ruff_args="check --fix"

        log_info "Running ruff check..."
        # shellcheck disable=SC2086
        if python -m ruff $ruff_args $python_dirs; then
            log_success "Ruff check passed"
        else
            log_error "Ruff check found issues"
            has_errors=true
        fi

        # Ruff format check
        log_info "Running ruff format check..."
        # shellcheck disable=SC2086
        if python -m ruff format --check $python_dirs; then
            log_success "Ruff format check passed"
        else
            log_error "Ruff format check found issues"
            [[ "$FIX_MODE" != true ]] && has_errors=true
        fi
    else
        log_warn "ruff not installed, skipping"
    fi

    # Mypy
    if detect_mypy && python -m mypy --version &>/dev/null; then
        log_info "Running mypy..."
        local src_dirs
        src_dirs=$(get_python_src_dirs)
        # shellcheck disable=SC2086
        if python -m mypy $src_dirs; then
            log_success "Mypy passed"
        else
            log_error "Mypy found issues"
            has_errors=true
        fi
    fi

    [[ "$has_errors" == true ]] && ((ERRORS++))
}
{% endif %}
{% if has_frontend %}

lint_frontend() {
    if ! detect_frontend; then
        log_debug "No frontend project detected, skipping"
        return 0
    fi

    log_step "Frontend Linting"

    local frontend_dir
    frontend_dir=$(get_frontend_dir)

    if [[ -z "$frontend_dir" ]] || [[ ! -d "$frontend_dir" ]]; then
        log_warn "Frontend directory not found"
        return 0
    fi

    pushd "$frontend_dir" > /dev/null

    local has_errors=false

    # ESLint
    if detect_eslint; then
        log_info "Running ESLint..."
        local eslint_args=""
        [[ "$FIX_MODE" == true ]] && eslint_args="--fix"

        if npm run lint -- $eslint_args 2>/dev/null; then
            log_success "ESLint passed"
        else
            log_error "ESLint found issues"
            has_errors=true
        fi
    fi

    # TypeScript
    if detect_typescript; then
        log_info "Running TypeScript compiler..."
        if npx tsc --noEmit; then
            log_success "TypeScript check passed"
        else
            log_error "TypeScript found errors"
            has_errors=true
        fi
    fi

    popd > /dev/null

    [[ "$has_errors" == true ]] && ((ERRORS++))
}
{% endif %}

# =============================================================================
# Main
# =============================================================================

main() {
    setup_colors
    parse_args "$@"

    if [[ "$FIX_MODE" == true ]]; then
        log_info "Running linters with auto-fix..."
    else
        log_info "Running linters..."
    fi
{% if has_python and has_frontend %}
    [[ "$FRONTEND_ONLY" != true ]] && lint_python
    [[ "$PYTHON_ONLY" != true ]] && lint_frontend
{% elif has_python %}
    lint_python
{% elif has_frontend %}
    lint_frontend
{% endif %}

    local end_time duration
    end_time=$(date +%s)
    duration=$((end_time - START_TIME))

    log_summary "Lint Summary"

    if [[ $ERRORS -eq 0 ]]; then
        log_success "All linting checks passed! ($(format_duration $duration))"
        exit $EXIT_SUCCESS
    else
        log_error "$ERRORS linting check(s) failed ($(format_duration $duration))"
        exit $EXIT_LINT_FAIL
    fi
}

main "$@"
